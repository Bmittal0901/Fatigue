<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fatigue Detection Typing Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    h2, h3 {
      font-size: 24px;
    }
    textarea, input[type="text"], select {
      width: 100%;
      font-size: 16px;
      margin-top: 10px;
      padding: 10px;
    }
    textarea {
      height: 150px;
      user-select: none;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 16px;
    }
    .status, .metrics {
      margin-top: 20px;
      font-weight: bold;
    }
    #progressContainer {
      margin-top: 10px;
      height: 20px;
      background: #eee;
      border-radius: 5px;
      overflow: hidden;
    }
    #progressBar {
      height: 100%;
      width: 0%;
      background-color: #4caf50;
    }
    @media (max-width: 600px) {
      textarea, input[type="text"] {
        font-size: 18px;
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <h2>Fatigue Detection Typing Test</h2>

  <div id="demographicForm">
    <h3>Demographic Information</h3>
    <label>Name: <input type="text" id="username" /></label><br><br>
    <label>Age Group:
      <select id="ageGroup">
        <option value="">Select</option>
        <option>Under 18</option><option>18–25</option><option>26–35</option>
        <option>36–50</option><option>51+</option>
      </select>
    </label><br><br>
    <label>Gender:
      <select id="gender">
        <option value="">Select</option>
        <option>Male</option><option>Female</option><option>Other</option><option>Prefer not to say</option>
      </select>
    </label><br><br>
    <label>Typing Skill:
      <select id="typingSkill">
        <option value="">Select</option>
        <option>Beginner</option><option>Intermediate</option><option>Advanced</option>
      </select>
    </label><br><br>
    <label>Occupation: <input type="text" id="occupation" /></label><br><br>
    <label>Daily Typing Hours:
      <select id="typingHours">
        <option value="">Select</option>
        <option>&lt;1</option><option>1–2</option><option>2–4</option><option>4–6</option><option>6+</option>
      </select>
    </label><br><br>
    <label>Mental Fatigue Level (1–5):
      <select id="mentalFatigue">
        <option value="">Select</option>
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      </select>
    </label><br><br>
    <label>Physical Fatigue Level (1–5):
      <select id="physicalFatigue">
        <option value="">Select</option>
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      </select>
    </label><br><br>
    <button onclick="submitDemographics()">Start Test</button>
  </div>

  <div id="typingTestContainer" style="display:none;">
    <p id="typingSentence">Loading sentence...</p>
    <textarea id="typingArea" placeholder="Start typing here..." autocorrect="off" autocomplete="off" autocapitalize="off" spellcheck="false"></textarea>

    <div id="progressContainer">
      <div id="progressBar"></div>
    </div>
    <p id="progressText">Sentence 0 of 10</p>

    <button onclick="submitSentence()">Submit Sentence</button>
    <button onclick="downloadSummaryCSV()">Download Summary CSV</button>
    <button onclick="clearAllSummaries()">Clear All Summaries</button>

    <div class="status" id="statusLabel"></div>
    <div class="metrics" id="metricsDisplay"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/@firebase/util"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDU56-FribrzudeFeh1-gz7ch25HHoWAGk",
      authDomain: "fatiguedetection-e13a1.firebaseapp.com",
      databaseURL: "https://fatiguedetection-e13a1-default-rtdb.firebaseio.com",
      projectId: "fatiguedetection-e13a1",
      storageBucket: "fatiguedetection-e13a1.appspot.com",
      messagingSenderId: "239129487774",
      appId: "1:239129487774:web:e6ceb32ddbaea27a7a8e8f"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const sentences = [
      "The quick brown fox jumps over the lazy dog.",
      "Typing speed can reveal your level of alertness.",
      "Consistency in typing patterns indicates low fatigue.",
      "Backspace usage often increases when you're tired.",
      "Stay focused and type the sentence shown above.",
      "Fast typing isn't always accurate typing.",
      "How many times do you press backspace per minute?",
      "Fatigue can impact typing rhythm and timing.",
      "A sleepy mind types with heavy fingers.",
      "Reaction time between keystrokes says a lot."
    ];

    let username = "";
    let index = 0;
    let logs = [];
    let keystrokes = 0;
    let backspaces = 0;
    let delays = [];
    let lastKeyTime = 0;
    let startTime = 0;

    const typingArea = document.getElementById("typingArea");

    typingArea.addEventListener("keydown", e => {
      if (!startTime) startTime = performance.now();
      const now = performance.now();
      if (e.key === "Backspace") backspaces++;
      else if (e.key.length === 1 || e.key === " ") keystrokes++;
      delays.push(now - lastKeyTime);
      lastKeyTime = now;
    });

    function getKeyDistance(a, b) {
      return a === b ? 0 : 1;
    }

    function calculateErrorRate(a, b) {
      let sum = 0;
      const len = Math.max(a.length, b.length);
      for (let i = 0; i < len; i++) sum += getKeyDistance(a[i], b[i]);
      return ((sum / len) * 100).toFixed(2);
    }

    function updateUI() {
      document.getElementById("typingSentence").innerText = sentences[index];
      document.getElementById("progressText").innerText = `Sentence ${index + 1} of ${sentences.length}`;
      document.getElementById("progressBar").style.width = `${((index) / sentences.length) * 100}%`;
      typingArea.value = "";
      typingArea.disabled = false;
      typingArea.focus();
      keystrokes = 0;
      backspaces = 0;
      delays = [];
      startTime = 0;
    }

    function loadUserProgress() {
      username = document.getElementById("username").value.trim();
      if (!username) return;
      index = 0;
      logs = [];
      updateUI();
    }

    function submitSentence() {
      if (!username || index >= sentences.length) return;
      const typed = typingArea.value.trim();
      const elapsed = (performance.now() - startTime) / 1000;
      const wpm = ((typed.length / 5) / (elapsed / 60)).toFixed(2);
      const errorRate = calculateErrorRate(sentences[index], typed);
      const avgIKI = (delays.reduce((a, b) => a + b, 0) / delays.length).toFixed(2);
      const kspc = (keystrokes / typed.length).toFixed(2);

      logs.push({ wpm, errorRate, avgIKI, kspc, backspaces });
      index++;

      if (index < sentences.length) {
        updateUI();
      } else {
        saveFinalSummary();
      }
    }

    function saveFinalSummary() {
      let sum = logs.reduce((acc, curr) => {
        acc.wpm += parseFloat(curr.wpm);
        acc.errorRate += parseFloat(curr.errorRate);
        acc.avgIKI += parseFloat(curr.avgIKI);
        acc.kspc += parseFloat(curr.kspc);
        acc.backspaces += parseInt(curr.backspaces);
        return acc;
      }, { wpm: 0, errorRate: 0, avgIKI: 0, kspc: 0, backspaces: 0 });

      const count = logs.length;
      const average = {
        username,
        wpm: (sum.wpm / count).toFixed(2),
        errorRate: (sum.errorRate / count).toFixed(2),
        avgIKI: (sum.avgIKI / count).toFixed(2),
        kspc: (sum.kspc / count).toFixed(2),
        backspaces: sum.backspaces,
        timestamp: new Date().toLocaleString()
      };

      database.ref(`summaryLogs/${username}/metrics`).set(average).then(() => {
        document.getElementById("statusLabel").innerText = "✅ All 10 sentences completed and summary saved!";
        document.getElementById("metricsDisplay").innerHTML = `
          WPM: ${average.wpm}<br>
          Error Rate: ${average.errorRate}%<br>
          Avg IKI: ${average.avgIKI} ms<br>
          KSPC: ${average.kspc}<br>
          Backspaces: ${average.backspaces}<br>
          Timestamp: ${average.timestamp}`;
        typingArea.disabled = true;
      });
    }

    function downloadSummaryCSV() {
      database.ref("summaryLogs").once("value").then(snapshot => {
        const logs = snapshot.val();
        const rows = [["Username", "WPM", "Error Rate (%)", "Avg IKI (ms)", "KSPC", "Backspaces", "Timestamp", "Age Group", "Gender", "Typing Skill", "Occupation", "Typing Hours", "Mental Fatigue", "Physical Fatigue"]];
        for (let user in logs) {
          const m = logs[user].metrics || {};
          const d = logs[user].demographics || {};
          rows.push([user, m.wpm, m.errorRate, m.avgIKI, m.kspc, m.backspaces, m.timestamp, d.ageGroup, d.gender, d.typingSkill, d.occupation, d.typingHours, d.mentalFatigue, d.physicalFatigue]);
        }
        const csv = rows.map(r => r.join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "summary_logs.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });
    }

    function clearAllSummaries() {
      if (confirm("Are you sure you want to delete all summary logs?")) {
        database.ref("summaryLogs").remove().then(() => {
          alert("✅ All summary logs cleared.");
        });
      }
    }

    function submitDemographics() {
      const usernameInput = document.getElementById("username");
      const usernameVal = usernameInput.value.trim();
      const ageGroup = document.getElementById("ageGroup").value;
      const gender = document.getElementById("gender").value;
      const typingSkill = document.getElementById("typingSkill").value;
      const occupation = document.getElementById("occupation").value;
      const typingHours = document.getElementById("typingHours").value;
      const mentalFatigue = document.getElementById("mentalFatigue").value;
      const physicalFatigue = document.getElementById("physicalFatigue").value;

      if (!usernameVal || !ageGroup || !gender || !typingSkill || !occupation || !typingHours || !mentalFatigue || !physicalFatigue) {
        alert("Please fill in all fields.");
        return;
      }

      localStorage.setItem("username", usernameVal);
      username = usernameVal;

      const demographics = {
        ageGroup, gender, typingSkill, occupation,
        typingHours, mentalFatigue, physicalFatigue,
        submittedAt: new Date().toLocaleString()
      };

      firebase.database().ref(`summaryLogs/${username}/demographics`).set(demographics).then(() => {
        document.getElementById("demographicForm").style.display = "none";
        document.getElementById("typingTestContainer").style.display = "block";
        loadUserProgress();
      });
    }
  </script>
</body>
</html>
