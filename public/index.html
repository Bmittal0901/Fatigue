<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fatigue Detection Typing Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    h2 {
      font-size: 24px;
    }
    textarea, input[type="text"] {
      width: 100%;
      font-size: 16px;
      margin-top: 10px;
      padding: 10px;
    }
    textarea {
      height: 150px;
      user-select: none;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 16px;
    }
    .status, .metrics {
      margin-top: 20px;
      font-weight: bold;
    }
    #progressContainer {
      margin-top: 10px;
      height: 20px;
      background: #eee;
      border-radius: 5px;
      overflow: hidden;
    }
    #progressBar {
      height: 100%;
      width: 0%;
      background-color: #4caf50;
    }
  </style>
</head>
<body>
  <h2>Fatigue Detection Typing Test</h2>

  <label for="username">Enter your name:</label>
  <input type="text" id="username" placeholder="e.g. bhavya123" onblur="loadUserProgress()" />

  <p id="typingSentence">Loading sentence...</p>
  <textarea id="typingArea" placeholder="Start typing here..." autocorrect="off" autocomplete="off" autocapitalize="off" spellcheck="false"></textarea>

  <div id="progressContainer">
    <div id="progressBar"></div>
  </div>
  <p id="progressText">Sentence 0 of 10</p>

  <button onclick="saveLog()">Submit Typing Log</button>
  <button onclick="downloadAllSummaries()">Download All Summaries</button>
  <button onclick="clearAllLogs()">Clear All Logs</button>

  <div class="status" id="statusLabel"></div>
  <div class="metrics" id="metricsDisplay"></div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDU56-FribrzudeFeh1-gz7ch25HHoWAGk",
      authDomain: "fatiguedetection-e13a1.firebaseapp.com",
      databaseURL: "https://fatiguedetection-e13a1-default-rtdb.firebaseio.com",
      projectId: "fatiguedetection-e13a1",
      storageBucket: "fatiguedetection-e13a1.appspot.com",
      messagingSenderId: "239129487774",
      appId: "1:239129487774:web:e6ceb32ddbaea27a7a8e8f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const sentencePool = [
      "The quick brown fox jumps over the lazy dog.",
      "Typing speed can reveal your level of alertness.",
      "Consistency in typing patterns indicates low fatigue.",
      "Backspace usage often increases when you're tired.",
      "Stay focused and type the sentence shown above.",
      "Fast typing isn't always accurate typing.",
      "How many times do you press backspace per minute?",
      "Fatigue can impact typing rhythm and timing.",
      "A sleepy mind types with heavy fingers.",
      "Reaction time between keystrokes says a lot."
    ];

    let sentenceIndex = 0;
    let userLogs = [];
    const typingArea = document.getElementById("typingArea");
    let keystrokes = 0;
    let totalBackspaces = 0;
    let startTime = null;
    let lastKeyTime = performance.now();
    let delays = [];

    const keyboardLayout = {
      'q':[0,0],'w':[1,0],'e':[2,0],'r':[3,0],'t':[4,0],'y':[5,0],'u':[6,0],'i':[7,0],'o':[8,0],'p':[9,0],
      'a':[0.5,1],'s':[1.5,1],'d':[2.5,1],'f':[3.5,1],'g':[4.5,1],'h':[5.5,1],'j':[6.5,1],'k':[7.5,1],'l':[8.5,1],
      'z':[1,2],'x':[2,2],'c':[3,2],'v':[4,2],'b':[5,2],'n':[6,2],'m':[7,2],' ':[5,3]
    };

    function getKeyDistance(a, b) {
      a = a.toLowerCase(); b = b.toLowerCase();
      if (!keyboardLayout[a] || !keyboardLayout[b]) return 1;
      const [x1, y1] = keyboardLayout[a], [x2, y2] = keyboardLayout[b];
      return Math.sqrt((x1 - x2) ** 2 + (y1 - y2) ** 2);
    }

    function calculateErrorRate(target, typed) {
      let totalDistance = 0, maxLength = Math.max(target.length, typed.length);
      for (let i = 0; i < maxLength; i++) {
        const targetChar = target[i] || "", typedChar = typed[i] || "";
        totalDistance += getKeyDistance(targetChar, typedChar);
      }
      return ((totalDistance / maxLength) * 10).toFixed(2);
    }

    function updateProgress() {
      const percent = ((sentenceIndex) / sentencePool.length) * 100;
      document.getElementById("progressBar").style.width = `${percent}%`;
      document.getElementById("progressText").innerText = `Sentence ${sentenceIndex} of ${sentencePool.length}`;
    }

    function loadUserProgress() {
      const username = document.getElementById("username").value.trim();
      if (!username) return;
      localStorage.setItem("username", username);
      sentenceIndex = 0;
      userLogs = [];
      loadNextSentence();
    }

    function loadNextSentence() {
      if (sentenceIndex >= sentencePool.length) return;
      document.getElementById("typingSentence").innerText = sentencePool[sentenceIndex];
      typingArea.value = "";
      typingArea.disabled = false;
      startTime = null;
      keystrokes = 0;
      totalBackspaces = 0;
      delays = [];
      lastKeyTime = performance.now();
      updateProgress();
    }

    typingArea.addEventListener("keydown", function (e) {
      if (!startTime) startTime = performance.now();
      const now = performance.now();
      if (e.key === "Backspace") totalBackspaces++;
      else if (e.key.length === 1 || e.key === " ") keystrokes++;
      delays.push(now - lastKeyTime);
      lastKeyTime = now;
    });

    function saveLog() {
      const username = document.getElementById("username").value.trim();
      if (!username) return alert("Please enter your username.");

      if (sentenceIndex >= sentencePool.length) return;

      const target = sentencePool[sentenceIndex];
      const typed = typingArea.value.trim();
      const timeTaken = (performance.now() - startTime) / 1000;
      const wpm = ((typed.length / 5) / (timeTaken / 60)).toFixed(2);
      const errorRate = calculateErrorRate(target, typed);
      const kspc = (keystrokes / typed.length).toFixed(2);
      const avgIKI = (delays.reduce((a, b) => a + b, 0) / delays.length).toFixed(2);

      userLogs.push({ wpm: parseFloat(wpm), errorRate: parseFloat(errorRate), avgIKI: parseFloat(avgIKI), kspc: parseFloat(kspc), backspaces: totalBackspaces });
      sentenceIndex++;

      document.getElementById("metricsDisplay").innerHTML = `WPM: ${wpm}<br>Error Rate: ${errorRate}%<br>Avg IKI: ${avgIKI} ms<br>KSPC: ${kspc}<br>Backspaces: ${totalBackspaces}`;

      if (sentenceIndex < sentencePool.length) loadNextSentence();
      else {
        typingArea.disabled = true;
        document.getElementById("typingSentence").innerText = " All 10 sentences completed!";
        saveUserSummary(username);
      }
    }

    function saveUserSummary(username) {
      let totalWPM = 0, totalErr = 0, totalIKI = 0, totalKSPC = 0, totalBack = 0;
      userLogs.forEach(log => {
        totalWPM += log.wpm;
        totalErr += log.errorRate;
        totalIKI += log.avgIKI;
        totalKSPC += log.kspc;
        totalBack += log.backspaces;
      });
      const summary = {
        username,
        avgWPM: (totalWPM / userLogs.length).toFixed(2),
        avgErrorRate: (totalErr / userLogs.length).toFixed(2),
        avgIKI: (totalIKI / userLogs.length).toFixed(2),
        avgKSPC: (totalKSPC / userLogs.length).toFixed(2),
        totalBackspaces: totalBack,
        timestamp: new Date().toISOString()
      };
      db.ref(`summaryLogs/${username}`).set(summary)
        .then(() => document.getElementById("statusLabel").innerText = " Final summary saved!")
        .catch(err => alert(" Failed to save summary."));
    }

    function downloadAllSummaries() {
      db.ref("summaryLogs").once("value").then(snapshot => {
        const logs = snapshot.val();
        const rows = [["Username", "Avg WPM", "Avg Error Rate", "Avg IKI", "Avg KSPC", "Total Backspaces", "Timestamp"]];
        Object.values(logs).forEach(log => {
          rows.push([log.username, log.avgWPM, log.avgErrorRate, log.avgIKI, log.avgKSPC, log.totalBackspaces, log.timestamp]);
        });
        const csv = rows.map(r => r.join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "summary_logs.csv";
        link.click();
      });
    }

    function clearAllLogs() {
      if (confirm(" This will delete ALL summary logs. Are you sure?")) {
        db.ref("summaryLogs").remove().then(() => alert(" All logs deleted."));
      }
    }

    window.onload = () => {
      const savedUser = localStorage.getItem("username");
      if (savedUser) {
        document.getElementById("username").value = savedUser;
        loadUserProgress();
      }
    };
  </script>
</body>
</html>
