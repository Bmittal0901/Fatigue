<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fatigue Detection Typing Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    h2 {
      font-size: 24px;
    }
    textarea, input[type="text"] {
      width: 100%;
      font-size: 16px;
      margin-top: 10px;
      padding: 10px;
    }
    textarea {
      height: 150px;
      user-select: none;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 16px;
    }
    .status, .metrics {
      margin-top: 20px;
      font-weight: bold;
    }
    #progressContainer {
      margin-top: 10px;
      height: 20px;
      background: #eee;
      border-radius: 5px;
      overflow: hidden;
    }
    #progressBar {
      height: 100%;
      width: 0%;
      background-color: #4caf50;
    }
    @media (max-width: 600px) {
      textarea, input[type="text"] {
        font-size: 18px;
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <h2>Fatigue Detection Typing Test</h2>

  <label for="username">Enter your name:</label>
  <input type="text" id="username" placeholder="e.g. bhavya123" onblur="loadUserProgress()" />

  <p id="typingSentence">Loading sentence...</p>
  <textarea id="typingArea" placeholder="Start typing here..." autocorrect="off" autocomplete="off" autocapitalize="off" spellcheck="false"></textarea>

  <div id="progressContainer">
    <div id="progressBar"></div>
  </div>
  <p id="progressText">Sentence 0 of 10</p>

  <button onclick="saveLog()">Submit Typing Log</button>
  <button onclick="downloadCSV()">Download Full CSV Log</button>
  <button id="downloadSummaryBtn" onclick="downloadUserSummary()" style="display:none;">Download Summary CSV</button>

  <div class="status" id="statusLabel"></div>
  <div class="metrics" id="metricsDisplay"></div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDU56-FribrzudeFeh1-gz7ch25HHoWAGk",
      authDomain: "fatiguedetection-e13a1.firebaseapp.com",
      databaseURL: "https://fatiguedetection-e13a1-default-rtdb.firebaseio.com",
      projectId: "fatiguedetection-e13a1",
      storageBucket: "fatiguedetection-e13a1.appspot.com",
      messagingSenderId: "239129487774",
      appId: "1:239129487774:web:e6ceb32ddbaea27a7a8e8f"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const sentencePool = [
      "The quick brown fox jumps over the lazy dog.",
      "Typing speed can reveal your level of alertness.",
      "Consistency in typing patterns indicates low fatigue.",
      "Backspace usage often increases when you're tired.",
      "Stay focused and type the sentence shown above.",
      "Fast typing isn't always accurate typing.",
      "How many times do you press backspace per minute?",
      "Fatigue can impact typing rhythm and timing.",
      "A sleepy mind types with heavy fingers.",
      "Reaction time between keystrokes says a lot."
    ];

    let sentenceIndex = 0;
    const typingArea = document.getElementById("typingArea");
    let keystrokes = 0;
    let totalBackspaces = 0;
    let startTime = null;
    let lastKeyTime = performance.now();
    let delays = [];

    function updateProgress() {
      const progressPercent = ((sentenceIndex) / sentencePool.length) * 100;
      document.getElementById("progressBar").style.width = `${progressPercent}%`;
      document.getElementById("progressText").innerText = `Sentence ${sentenceIndex} of ${sentencePool.length}`;
    }

    function loadUserProgress() {
      const username = document.getElementById("username").value.trim();
      if (!username) return;
      localStorage.setItem("username", username);
      database.ref(`typingLogs/${username}`).once("value").then((snapshot) => {
        const logs = snapshot.val();
        sentenceIndex = logs ? Object.keys(logs).length : 0;
        if (sentenceIndex >= sentencePool.length) {
          document.getElementById("typingSentence").innerText = "✅ All 10 sentences completed!";
          typingArea.disabled = true;
          document.getElementById("downloadSummaryBtn").style.display = "inline-block";
          showUserSummary();
        } else {
          loadNextSentence();
        }
      });
    }

    function loadNextSentence() {
      document.getElementById("typingSentence").innerText = sentencePool[sentenceIndex];
      typingArea.value = "";
      typingArea.disabled = false;
      startTime = null;
      keystrokes = 0;
      totalBackspaces = 0;
      delays = [];
      lastKeyTime = performance.now();
      updateProgress();
    }

    typingArea.addEventListener("keydown", function (event) {
      if (!startTime) startTime = performance.now();
      const now = performance.now();
      if (event.key === "Backspace") totalBackspaces++;
      else if (event.key.length === 1 || event.key === " ") keystrokes++;
      delays.push(now - lastKeyTime);
      lastKeyTime = now;
    });

    const keyboardLayout = { ... } // (Same as your existing layout)

    function getKeyDistance(a, b) { ... } // (Same as your existing function)

    function calculateErrorRate(target, typed) { ... } // (Same as your existing function)

    function saveLog() {
      const username = document.getElementById("username").value.trim();
      if (!username) return alert("Please enter your username.");
      document.getElementById("username").disabled = true;
      if (sentenceIndex >= sentencePool.length) return;

      const targetSentence = sentencePool[sentenceIndex];
      const typedText = typingArea.value.trim();
      const totalTime = (performance.now() - startTime) / 1000;
      const wpm = ((typedText.length / 5) / (totalTime / 60)).toFixed(2);
      const errorRate = calculateErrorRate(targetSentence, typedText);
      const kspc = (keystrokes / typedText.length).toFixed(2);
      const avgIKI = (delays.reduce((a, b) => a + b, 0) / delays.length).toFixed(2);

      const logData = { username, sentenceNumber: sentenceIndex + 1, target: targetSentence, typed: typedText, wpm, errorRate, avgIKI, kspc, backspaces: totalBackspaces, timestamp: new Date().toISOString() };

      database.ref(`typingLogs/${username}`).push(logData).then(() => {
        document.getElementById("statusLabel").innerText = `✅ Sentence ${sentenceIndex + 1} saved!`;
        document.getElementById("metricsDisplay").innerHTML = `WPM: ${wpm}<br>Error Rate: ${errorRate}%<br>Avg IKI: ${avgIKI} ms<br>KSPC: ${kspc}<br>Backspaces: ${totalBackspaces}`;
        sentenceIndex++;
        if (sentenceIndex < sentencePool.length) {
          loadNextSentence();
        } else {
          document.getElementById("typingSentence").innerText = "✅ All 10 sentences completed!";
          typingArea.disabled = true;
          document.getElementById("downloadSummaryBtn").style.display = "inline-block";
          showUserSummary();
        }
      });
    }

    function showUserSummary() {
      const username = document.getElementById("username").value.trim();
      database.ref(`typingLogs/${username}`).once("value").then(snapshot => {
        const logs = snapshot.val();
        let totalWPM = 0, totalErr = 0, totalIKI = 0, totalKSPC = 0, totalBack = 0;
        const count = Object.keys(logs).length;
        Object.values(logs).forEach(log => {
          totalWPM += parseFloat(log.wpm);
          totalErr += parseFloat(log.errorRate);
          totalIKI += parseFloat(log.avgIKI);
          totalKSPC += parseFloat(log.kspc);
          totalBack += parseInt(log.backspaces);
        });
        document.getElementById("metricsDisplay").innerHTML += `<hr><strong>Summary (10 Sentences):</strong><br>Avg WPM: ${(totalWPM / count).toFixed(2)}<br>Avg Error Rate: ${(totalErr / count).toFixed(2)}%<br>Avg IKI: ${(totalIKI / count).toFixed(2)} ms<br>Avg KSPC: ${(totalKSPC / count).toFixed(2)}<br>Total Backspaces: ${totalBack}`;
      });
    }

    function downloadUserSummary() {
      const username = document.getElementById("username").value.trim();
      database.ref(`typingLogs/${username}`).once("value").then(snapshot => {
        const logs = snapshot.val();
        const rows = [["Sentence #", "Target Sentence", "Typed Sentence", "WPM", "Error Rate (%)", "Avg IKI (ms)", "KSPC", "Backspaces", "Timestamp"]];
        Object.values(logs).forEach((log, idx) => {
          rows.push([idx + 1, `"${log.target}"`, `"${log.typed}"`, log.wpm, log.errorRate, log.avgIKI, log.kspc, log.backspaces, log.timestamp]);
        });
        const csvContent = rows.map(row => row.join(",")).join("\n");
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${username}_summary.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });
    }

    window.onload = () => {
      const savedUser = localStorage.getItem("username");
      if (savedUser) {
        document.getElementById("username").value = savedUser;
        loadUserProgress();
      }
    }
  </script>
</body>
</html>
