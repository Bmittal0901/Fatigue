<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fatigue Detection Typing Test</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(to right, #eef2f3, #ffffff);
      font-family: 'Space Grotesk', 'Inter', sans-serif;
    }
    .sidebar, .main-panel, .control-panel {
      background-color: #ffffffdd;
      backdrop-filter: blur(12px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      padding: 1.5rem;
      height: 100vh;
      overflow-y: auto;
      border-radius: 0.75rem;
    }
    h4, h5 {
      font-weight: 600;
    }
    textarea {
      height: 160px;
      border-radius: 0.5rem;
    }
    .metrics-box span {
      display: block;
      font-weight: bold;
      font-size: 1.2rem;
    }
    .form-label.required::after {
      content: " *";
      color: red;
    }
    .fade-in {
      animation: fadeIn 0.6s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    button {
      border-radius: 0.5rem;
    }
    #statusLabel {
      font-weight: 600;
      font-size: 1.1rem;
    }
    .progress {
      height: 10px;
      border-radius: 5px;
    }
    .progress-bar {
      background: #1f8ef1;
    }
    #metricsDisplay b {
      display: inline-block;
      width: 120px;
    }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row g-3">
    <div class="col-md-3 sidebar">
      <h5 class="mb-3"><i class="fas fa-user"></i> Participant Info</h5>
      <div class="mb-3">
        <label class="form-label required">Name</label>
        <input type="text" id="username" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label required">Age Group</label>
        <select id="ageGroup" class="form-select" required>
          <option value="">Select</option>
          <option>Under 18</option><option>18–25</option><option>26–35</option>
          <option>36–50</option><option>51+</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label required">Gender</label>
        <select id="gender" class="form-select" required>
          <option value="">Select</option>
          <option>Male</option><option>Female</option><option>Other</option><option>Prefer not to say</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label required">Typing Skill</label>
        <select id="typingSkill" class="form-select" required>
          <option value="">Select</option>
          <option>Beginner</option><option>Intermediate</option><option>Advanced</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label required">Occupation</label>
        <input type="text" id="occupation" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label required">Typing Hours</label>
        <select id="typingHours" class="form-select" required>
          <option value="">Select</option>
          <option><1</option><option>1–2</option><option>2–4</option><option>4–6</option><option>6+</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Mental Fatigue (0–5): <span id="mentalFatigueValue">0</span></label>
        <input type="range" id="mentalFatigue" class="form-range" min="0" max="5" value="0" oninput="document.getElementById('mentalFatigueValue').innerText = this.value">
      </div>
      <div class="mb-3">
        <label class="form-label">Physical Fatigue (0–5): <span id="physicalFatigueValue">0</span></label>
        <input type="range" id="physicalFatigue" class="form-range" min="0" max="5" value="0" oninput="document.getElementById('physicalFatigueValue').innerText = this.value">
      </div>
      <button class="btn btn-primary w-100" onclick="submitDemographics()"><i class="fas fa-play"></i> Start Test</button>
    </div>

    <div class="col-md-6 main-panel fade-in">
      <h4 class="mb-3">⌨️ Typing Test</h4>
      <p id="typingSentence" class="fs-5 fw-semibold">Please enter details to start the test.</p>
      <textarea id="typingArea" class="form-control" disabled placeholder="Your typing area..."></textarea>
      <div class="progress my-3">
        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
      </div>
      <p class="text-end fw-semibold" id="progressText">Sentence 0 of 10</p>
      <div class="d-grid gap-2">
        <button class="btn btn-success" onclick="submitSentence()"><i class="fas fa-check"></i> Submit Sentence</button>
      </div>
      <div class="text-success mt-3" id="statusLabel"></div>
      <div class="text-muted mt-2" id="metricsDisplay"></div>
    </div>

    <div class="col-md-3 control-panel">
      <h5 class="mb-3"><i class="fas fa-chart-line"></i> Live Analytics</h5>
      <div class="mb-3 metrics-box">
        <label>Live WPM</label>
        <span id="liveWpm">0</span>
        <label>Error %</label>
        <span id="liveError">0%</span>
        <label>Avg IKI (ms)</label>
        <span id="liveIki">0</span>
        <label>KSPC</label>
        <span id="liveKspc">0</span>
        <label>Backspaces</label>
        <span id="liveBackspace">0</span>
      </div>
      <hr>
      <button class="btn btn-outline-secondary w-100 mb-2" onclick="downloadSummaryCSV()"><i class="fas fa-download"></i> Download CSV</button>
      <button class="btn btn-outline-danger w-100" onclick="clearAllSummaries()"><i class="fas fa-trash"></i> Clear Logs</button>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script>
  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDU56-FribrzudeFeh1-gz7ch25HHoWAGk",
    authDomain: "fatiguedetection-e13a1.firebaseapp.com",
    databaseURL: "https://fatiguedetection-e13a1-default-rtdb.firebaseio.com",
    projectId: "fatiguedetection-e13a1",
    storageBucket: "fatiguedetection-e13a1.appspot.com",
    messagingSenderId: "239129487774",
    appId: "1:239129487774:web:e6ceb32ddbaea27a7a8e8f"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
const sentences = [
  "The quick brown fox jumps over the lazy dog.",
  "Typing speed can reveal your level of alertness.",
  "Consistency in typing patterns indicates low fatigue.",
  "Backspace usage often increases when you're tired.",
  "Stay focused and type the sentence shown above.",
  "Fast typing isn't always accurate typing.",
  "How many times do you press backspace per minute?",
  "Fatigue can impact typing rhythm and timing.",
  "A sleepy mind types with heavy fingers.",
  "Reaction time between keystrokes says a lot."
];

let username = "";
let index = 0;
let logs = [];
let keystrokes = 0;
let backspaces = 0;
let delays = [];
let lastKeyTime = 0;
let startTime = 0;

const typingArea = document.getElementById("typingArea");

// Event listener for keydown on the typing area
typingArea.addEventListener("keydown", e => {
  const now = performance.now();

  // Set startTime only on the very first key press for the current sentence
  if (startTime === 0) {
    startTime = now;
  }

  // Block navigation keys, Home, End, and Delete
  const blockedKeys = ["ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown", "Home", "End", "Delete"];
  if (blockedKeys.includes(e.key)) {
    e.preventDefault();
    return; // Stop processing if a blocked key is pressed
  }

  if (e.key.length === 1 || e.key === " ") {
    keystrokes++;
  } else if (e.key === "Backspace") {
    backspaces++;
  }

  // Calculate IKI only if it's not the very first key of the sentence
  if (lastKeyTime > 0) {
    delays.push(now - lastKeyTime);
  }
  lastKeyTime = now;

  // IMPORTANT: Ensure caret stays at the end after every key press
  // This is crucial for preventing users from moving back.
  setTimeout(() => {
      typingArea.selectionStart = typingArea.selectionEnd = typingArea.value.length;
  }, 0); // Use setTimeout to ensure this runs after the key's default action
});

function updateUI() {
  document.getElementById("typingSentence").innerText = sentences[index];
  document.getElementById("progressText").innerText = `Sentence ${index + 1} of ${sentences.length}`;
  document.getElementById("progressBar").style.width = `${(index / sentences.length) * 100}%`;

  typingArea.disabled = false;
  typingArea.readOnly = false; // Ensure it's not read-only
  typingArea.value = "";
  typingArea.focus();

  // Reset tracking variables for the new sentence
  keystrokes = 0;
  backspaces = 0;
  delays = [];
  startTime = 0; // Reset startTime for the next sentence
  lastKeyTime = 0; // Reset lastKeyTime for the next sentence

  // Apply strict caret control and selection prevention
  typingArea.style.userSelect = "none";         // Disable text selection
  typingArea.style.caretColor = "";  // Hide blinking cursor

  // Prevent mouse/touch interactions from moving caret or selecting text
  typingArea.onmousedown = (e) => e.preventDefault();
  typingArea.ontouchstart = (e) => e.preventDefault();
  typingArea.onselectstart = (e) => e.preventDefault();

  // Ensure mobile keyboards don’t autocorrect or suggest
  typingArea.setAttribute("autocorrect", "off");
  typingArea.setAttribute("autocapitalize", "off");
  typingArea.setAttribute("spellcheck", "false");

  // Force caret to the end initially, and ensure input area is in view
  setTimeout(() => {
    typingArea.selectionStart = typingArea.selectionEnd = typingArea.value.length;
    typingArea.scrollIntoView({ behavior: "smooth", block: "center" });
  }, 200);
}

function loadUserProgress() {
  username = document.getElementById("username").value.trim();
  if (!username) return;
  index = 0;
  logs = [];
}

function submitDemographics() {
  const u = document.getElementById("username").value.trim();
  const ageGroup = document.getElementById("ageGroup").value;
  const gender = document.getElementById("gender").value;
  const typingSkill = document.getElementById("typingSkill").value;
  const occupation = document.getElementById("occupation").value;
  const typingHours = document.getElementById("typingHours").value;
  const mentalFatigue = document.getElementById("mentalFatigue").value;
  const physicalFatigue = document.getElementById("physicalFatigue").value;

  if (!u || !ageGroup || !gender || !typingSkill || !occupation || !typingHours) {
    alert("Please fill in all required fields.");
    return;
  }

  username = u;
  const demographics = {
    ageGroup, gender, typingSkill, occupation,
    typingHours, mentalFatigue, physicalFatigue,
    submittedAt: new Date().toLocaleString().replace(",", "")
  };

  database.ref(`summaryLogs/${username}/demographics`).set(demographics).then(() => {
    loadUserProgress(); // Resets index and logs for a new user/test
    typingArea.removeAttribute("disabled"); // Enable typing area
    document.getElementById("statusLabel").innerText = "✅ Test Started";
    updateUI(); // Load the first sentence and prepare the UI
  }).catch(error => {
    console.error("Error submitting demographics:", error);
    alert("Failed to start test. Please try again.");
  });
}

// Function to calculate error rate between original and typed text
function calculateErrorRate(original, typed) {
  let errors = 0;
  const len = Math.max(original.length, typed.length);
  for (let i = 0; i < len; i++) {
    if (original[i] !== typed[i]) {
      errors++;
    }
  }
  // If original is empty, prevent division by zero
  return original.length > 0 ? (errors / original.length * 100).toFixed(2) : "0.00";
}


function submitSentence() {
  if (!username || index >= sentences.length) {
      document.getElementById("statusLabel").innerText = "Test completed or not started.";
      return;
  }

  const typed = typingArea.value; // Get the raw typed value
  const originalSentence = sentences[index];

  if (startTime === 0 || typed.length === 0) { // Check for empty typed content
    alert("Please type before submitting.");
    return;
  }

  const elapsed = (performance.now() - startTime) / 1000;
  const wpm = ((typed.length / 5) / (elapsed / 60)).toFixed(2); // WPM calculation based on 5 chars per word
  const errorRate = calculateErrorRate(originalSentence, typed);
  const avgIKI = (delays.length > 0 ? (delays.reduce((a, b) => a + b, 0) / delays.length) : 0).toFixed(2);
  const kspc = (typed.length > 0 ? (keystrokes / typed.length) : 0).toFixed(2);

  logs.push({ wpm, errorRate, avgIKI, kspc, backspaces });

  // Show live metrics
  document.getElementById("liveWpm").innerText = wpm;
  document.getElementById("liveError").innerText = errorRate + "%";
  document.getElementById("liveIki").innerText = avgIKI;
  document.getElementById("liveKspc").innerText = kspc;
  document.getElementById("liveBackspace").innerText = backspaces;

  // Reset after logging - these are correctly placed here now.
  startTime = 0;
  lastKeyTime = 0;

  index++; // Move to the next sentence

  if (index < sentences.length) {
    updateUI(); // Load the next sentence
  } else {
    saveFinalSummary(); // All sentences are complete
  }
}

function saveFinalSummary() {
  let sum = logs.reduce((acc, curr) => {
    acc.wpm += parseFloat(curr.wpm);
    acc.errorRate += parseFloat(curr.errorRate);
    acc.avgIKI += parseFloat(curr.avgIKI);
    acc.kspc += parseFloat(curr.kspc);
    acc.backspaces += parseInt(curr.backspaces);
    return acc;
  }, { wpm: 0, errorRate: 0, avgIKI: 0, kspc: 0, backspaces: 0 });

  const count = logs.length;
  const average = {
    username,
    wpm: (sum.wpm / count).toFixed(2),
    errorRate: (sum.errorRate / count).toFixed(2),
    avgIKI: (sum.avgIKI / count).toFixed(2),
    kspc: (sum.kspc / count).toFixed(2),
    backspaces: (sum.backspaces / count).toFixed(2),
    timestamp: new Date().toLocaleString().replace(",", "")
  };

  database.ref(`summaryLogs/${username}/metrics`).set(average).then(() => {
    document.getElementById("statusLabel").innerText = "✅ All sentences complete. Summary saved!";
    document.getElementById("metricsDisplay").innerHTML = `
      <b>WPM:</b> ${average.wpm}<br>
      <b>Error Rate:</b> ${average.errorRate}%<br>
      <b>Avg IKI:</b> ${average.avgIKI} ms<br>
      <b>KSPC:</b> ${average.kspc}<br>
      <b>Backspaces:</b> ${average.backspaces}<br>
      <b>Timestamp:</b> ${average.timestamp}`;
    typingArea.disabled = true; // Disable typing area after test completion
    typingArea.value = ""; // Clear typing area
  }).catch(error => {
    console.error("Error saving final summary:", error);
    document.getElementById("statusLabel").innerText = "Failed to save summary.";
  });
}

function downloadSummaryCSV() {
  database.ref("summaryLogs").once("value").then(snapshot => {
    const logs = snapshot.val();
    const rows = [["Username", "WPM", "Error Rate (%)", "Avg IKI (ms)", "KSPC", "Backspaces", "Timestamp", "Age Group", "Gender", "Typing Skill", "Occupation", "Typing Hours", "Mental Fatigue", "Physical Fatigue"]];
    
    if (!logs) { // Handle case where there are no logs
        alert("No logs to download.");
        return;
    }

    for (let user in logs) {
      const m = logs[user].metrics || {}; // Use empty object if metrics is null/undefined
      const d = logs[user].demographics || {}; // Use empty object if demographics is null/undefined
      rows.push([
        user,
        m.wpm || '', m.errorRate || '', m.avgIKI || '', m.kspc || '', m.backspaces || '', m.timestamp || '',
        d.ageGroup || '', d.gender || '', d.typingSkill || '', d.occupation || '', d.typingHours || '',
        d.mentalFatigue || '', d.physicalFatigue || ''
      ]);
    }
    const csv = rows.map(r => r.join(",")).join("\n");
    const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "fatigue_detection_summary_logs.csv"; // More descriptive filename
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url); // Clean up the URL object
  }).catch(error => {
    console.error("Error downloading CSV:", error);
    alert("Failed to download logs. Check console for details.");
  });
}

function clearAllSummaries() {
  if (confirm("Are you sure you want to clear ALL logs? This action cannot be undone.")) {
    database.ref("summaryLogs").remove().then(() => {
      alert("✅ All logs cleared successfully.");
      // Optional: Reset UI after clearing logs
      username = "";
      index = 0;
      logs = [];
      document.getElementById("typingSentence").innerText = "Please enter details to start the test.";
      document.getElementById("typingArea").value = "";
      document.getElementById("typingArea").disabled = true;
      document.getElementById("statusLabel").innerText = "";
      document.getElementById("metricsDisplay").innerHTML = "";
      document.getElementById("liveWpm").innerText = "0";
      document.getElementById("liveError").innerText = "0%";
      document.getElementById("liveIki").innerText = "0";
      document.getElementById("liveKspc").innerText = "0";
      document.getElementById("liveBackspace").innerText = "0";
      document.getElementById("progressBar").style.width = "0%";
      document.getElementById("progressText").innerText = "Sentence 0 of 10";
    }).catch(error => {
      console.error("Error clearing logs:", error);
      alert("Failed to clear logs. Check console for details.");
    });
  }
}
</script>
</body>
</html>
