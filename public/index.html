<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fatigue Detection Typing Test</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      background: #f1f4f9;
      font-family: 'Inter', sans-serif;
    }
    .sidebar, .main-panel, .control-panel {
      background-color: #ffffffcc;
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 1.5rem;
      height: 100vh;
      overflow-y: auto;
    }
    textarea {
      height: 150px;
    }
    .metrics-box span {
      display: block;
      font-weight: bold;
      font-size: 1.1rem;
    }
    .form-label.required::after {
      content: " *";
      color: red;
    }
    .fade-in {
      animation: fadeIn 0.6s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <!-- Left Sidebar -->
    <div class="col-md-3 sidebar">
      <h5 class="mb-3"><i class="fas fa-user"></i> Participant Info</h5>
      <div class="mb-3">
        <label class="form-label required">Name</label>
        <input type="text" id="username" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label required">Age Group</label>
        <select id="ageGroup" class="form-select" required>
          <option value="">Select</option>
          <option>Under 18</option><option>18–25</option><option>26–35</option>
          <option>36–50</option><option>51+</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label required">Gender</label>
        <select id="gender" class="form-select" required>
          <option value="">Select</option>
          <option>Male</option><option>Female</option><option>Other</option><option>Prefer not to say</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label required">Typing Skill</label>
        <select id="typingSkill" class="form-select" required>
          <option value="">Select</option>
          <option>Beginner</option><option>Intermediate</option><option>Advanced</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label required">Occupation</label>
        <input type="text" id="occupation" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label required">Typing Hours</label>
        <select id="typingHours" class="form-select" required>
          <option value="">Select</option>
          <option><1</option><option>1–2</option><option>2–4</option><option>4–6</option><option>6+</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Mental Fatigue (0–5): <span id="mentalFatigueValue">0</span></label>
        <input type="range" id="mentalFatigue" class="form-range" min="0" max="5" value="0" oninput="document.getElementById('mentalFatigueValue').innerText = this.value">
     </div>
    <div class="mb-3">
      <label class="form-label">Physical Fatigue (0–5): <span id="physicalFatigueValue">0</span></label>
      <input type="range" id="physicalFatigue" class="form-range" min="0" max="5" value="0" oninput="document.getElementById('physicalFatigueValue').innerText = this.value">
</div>

      <button class="btn btn-primary w-100" onclick="submitDemographics()"><i class="fas fa-play"></i> Start Test</button>
    </div>

    <!-- Center Panel -->
    <div class="col-md-6 main-panel fade-in">
      <h4 class="mb-3">⌨️ Typing Test</h4>
      <p id="typingSentence">Please enter details to start the test.</p>
      <textarea id="typingArea" class="form-control" disabled placeholder="Your typing area..."></textarea>
      <div class="progress my-3">
        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
      </div>
      <p class="text-end" id="progressText">Sentence 0 of 10</p>
      <div class="d-grid gap-2">
        <button class="btn btn-success" onclick="submitSentence()"><i class="fas fa-check"></i> Submit Sentence</button>
      </div>
      <div class="text-success mt-3" id="statusLabel"></div>
      <div class="text-muted mt-2" id="metricsDisplay"></div>
    </div>

    <!-- Right Sidebar -->
    <div class="col-md-3 control-panel">
      <h5 class="mb-3"><i class="fas fa-chart-line"></i> Live Analytics</h5>
      <div class="mb-3 metrics-box">
        <label>Live WPM</label>
        <span id="liveWpm">0</span>
        <label>Error %</label>
        <span id="liveError">0%</span>
        <label>Avg IKI (ms)</label>
        <span id="liveIki">0</span>
        <label>KSPC</label>
        <span id="liveKspc">0</span>
        <label>Backspaces</label>
        <span id="liveBackspace">0</span>
      </div>
      <hr>
      <button class="btn btn-outline-secondary w-100 mb-2" onclick="downloadSummaryCSV()"><i class="fas fa-download"></i> Download CSV</button>
      <button class="btn btn-outline-danger w-100" onclick="clearAllSummaries()"><i class="fas fa-trash"></i> Clear Logs</button>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDU56-FribrzudeFeh1-gz7ch25HHoWAGk",
  authDomain: "fatiguedetection-e13a1.firebaseapp.com",
  databaseURL: "https://fatiguedetection-e13a1-default-rtdb.firebaseio.com",
  projectId: "fatiguedetection-e13a1",
  storageBucket: "fatiguedetection-e13a1.appspot.com",
  messagingSenderId: "239129487774",
  appId: "1:239129487774:web:e6ceb32ddbaea27a7a8e8f"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

const sentences = [
  "The quick brown fox jumps over the lazy dog.",
  "Typing speed can reveal your level of alertness.",
  "Consistency in typing patterns indicates low fatigue.",
  "Backspace usage often increases when you're tired.",
  "Stay focused and type the sentence shown above.",
  "Fast typing isn't always accurate typing.",
  "How many times do you press backspace per minute?",
  "Fatigue can impact typing rhythm and timing.",
  "A sleepy mind types with heavy fingers.",
  "Reaction time between keystrokes says a lot."
];

let username = "";
let index = 0;
let logs = [];
let keystrokes = 0;
let backspaces = 0;
let delays = [];
let lastKeyTime = 0;
let startTime = 0;
let typingArea = document.getElementById("typingArea");

typingArea.addEventListener("keydown", e => {
  const now = performance.now();

  if (!startTime) startTime = now;

  // Count keystrokes and backspaces only for actual characters or space
  if (e.key.length === 1 || e.key === " ") {
    keystrokes++;
  } else if (e.key === "Backspace") {
    backspaces++;
  }

  if (lastKeyTime > 0) {
    delays.push(now - lastKeyTime);
  }
  lastKeyTime = now;
});

function getKeyDistance(a, b) {
  return a === b ? 0 : 1;
}

function calculateErrorRate(a, b) {
  let sum = 0;
  const len = Math.max(a.length, b.length);
  for (let i = 0; i < len; i++) sum += getKeyDistance(a[i] || "", b[i] || "");
  return ((sum / len) * 100).toFixed(2);
}

function updateUI() {
  document.getElementById("typingSentence").innerText = sentences[index];
  document.getElementById("progressText").innerText = `Sentence ${index + 1} of ${sentences.length}`;
  document.getElementById("progressBar").style.width = `${((index) / sentences.length) * 100}%`;
  typingArea.value = "";
  typingArea.disabled = false;
  typingArea.focus();
  keystrokes = 0;
  backspaces = 0;
  delays = [];
  startTime = 0;
  lastKeyTime = 0;
}

function loadUserProgress() {
  username = document.getElementById("username").value.trim();
  if (!username) return;
  index = 0;
  logs = [];
  updateUI();
}

function submitDemographics() {
  const u = document.getElementById("username").value.trim();
  const ageGroup = document.getElementById("ageGroup").value;
  const gender = document.getElementById("gender").value;
  const typingSkill = document.getElementById("typingSkill").value;
  const occupation = document.getElementById("occupation").value;
  const typingHours = document.getElementById("typingHours").value;
  const mentalFatigue = document.getElementById("mentalFatigue").value;
  const physicalFatigue = document.getElementById("physicalFatigue").value;

  if (!u || !ageGroup || !gender || !typingSkill || !occupation || !typingHours) {
    alert("Please fill in all required fields.");
    return;
  }

  username = u;
  const demographics = {
    ageGroup, gender, typingSkill, occupation,
    typingHours, mentalFatigue, physicalFatigue,
    submittedAt: new Date().toLocaleString().replace(",", "")
  };

  firebase.database().ref(`summaryLogs/${username}/demographics`).set(demographics).then(() => {
    loadUserProgress();
    typingArea.removeAttribute("disabled");
    document.getElementById("statusLabel").innerText = "✅ Test Started";
  });
}

function submitSentence() {
  if (!username || index >= sentences.length) return;

  const typed = typingArea.value.trim();

  if (!startTime) {
    alert("Please type before submitting.");
    return;
  }

  const elapsed = (performance.now() - startTime) / 1000;
  if (elapsed <= 0 || !typed.length) {
    alert("Please type the sentence before submitting.");
    return;
  }

  const wpm = ((typed.length / 5) / (elapsed / 60)).toFixed(2);
  const errorRate = calculateErrorRate(sentences[index], typed);
  const avgIKI = (delays.length > 0 ? (delays.reduce((a, b) => a + b, 0) / delays.length) : 0).toFixed(2);
  const kspc = (typed.length > 0 ? (keystrokes / typed.length) : 0).toFixed(2);

  logs.push({ wpm, errorRate, avgIKI, kspc, backspaces });

  index++;

  if (index < sentences.length) {
   // ✅ Update live metrics AFTER resetting fields
    document.getElementById("liveWpm").innerText = wpm;
    document.getElementById("liveError").innerText = errorRate + "%";
    document.getElementById("liveIki").innerText = avgIKI;
    document.getElementById("liveKspc").innerText = kspc;
    document.getElementById("liveBackspace").innerText = backspaces;
    updateUI(); // reset typing state
  } else {
    saveFinalSummary();
  }
}

function saveFinalSummary() {
  let sum = logs.reduce((acc, curr) => {
    acc.wpm += parseFloat(curr.wpm);
    acc.errorRate += parseFloat(curr.errorRate);
    acc.avgIKI += parseFloat(curr.avgIKI);
    acc.kspc += parseFloat(curr.kspc);
    acc.backspaces += parseInt(curr.backspaces);
    return acc;
  }, { wpm: 0, errorRate: 0, avgIKI: 0, kspc: 0, backspaces: 0 });

  const count = logs.length;
  const average = {
    username,
    wpm: (sum.wpm / count).toFixed(2),
    errorRate: (sum.errorRate / count).toFixed(2),
    avgIKI: (sum.avgIKI / count).toFixed(2),
    kspc: (sum.kspc / count).toFixed(2),
    backspaces: sum.backspaces,
    timestamp: new Date().toLocaleString().replace(",", "")
  };

  database.ref(`summaryLogs/${username}/metrics`).set(average).then(() => {
    document.getElementById("statusLabel").innerText = "✅ All sentences complete. Summary saved!";
    document.getElementById("metricsDisplay").innerHTML = `
      <b>WPM:</b> ${average.wpm}<br>
      <b>Error Rate:</b> ${average.errorRate}%<br>
      <b>Avg IKI:</b> ${average.avgIKI} ms<br>
      <b>KSPC:</b> ${average.kspc}<br>
      <b>Backspaces:</b> ${average.backspaces}<br>
      <b>Timestamp:</b> ${average.timestamp}`;
    typingArea.disabled = true;
  });
}

function downloadSummaryCSV() {
  database.ref("summaryLogs").once("value").then(snapshot => {
    const logs = snapshot.val();
    const rows = [["Username", "WPM", "Error Rate (%)", "Avg IKI (ms)", "KSPC", "Backspaces", "Timestamp", "Age Group", "Gender", "Typing Skill", "Occupation", "Typing Hours", "Mental Fatigue", "Physical Fatigue"]];
    for (let user in logs) {
      const m = logs[user].metrics || {};
      const d = logs[user].demographics || {};
      rows.push([user, m.wpm, m.errorRate, m.avgIKI, m.kspc, m.backspaces, m.timestamp, d.ageGroup, d.gender, d.typingSkill, d.occupation, d.typingHours, d.mentalFatigue, d.physicalFatigue]);
    }
    const csv = rows.map(r => r.join(",")).join("\n");
    const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "summary_logs.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  });
}

function clearAllSummaries() {
  if (confirm("Clear all logs? This cannot be undone.")) {
    database.ref("summaryLogs").remove().then(() => {
      alert("✅ Logs cleared.");
    });
  }
}
</script>
</body>
</html>
